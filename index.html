<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales - Store</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background-color: white;
      color: #222;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark {
      background-color: #121212;
      color: #eee;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: #c62828; /* red */
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    h1 {
      margin: 0;
      font-size: 1.4rem;
    }
    #menu-btn {
      background: none;
      border: none;
      font-size: 1.6rem;
      color: white;
      cursor: pointer;
      position: relative;
    }
    #menu-content {
      position: absolute;
      top: 35px;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      display: none;
      min-width: 160px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
      border-radius: 4px;
      z-index: 100;
    }
    body.dark #menu-content {
      background: #222;
      border-color: #555;
      color: #eee;
    }
    #menu-content button {
      width: 100%;
      padding: 10px;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      font-size: 1rem;
    }
    #menu-content button:hover {
      background-color: #eee;
    }
    body.dark #menu-content button:hover {
      background-color: #444;
    }
    main {
      max-width: 400px;
      margin: 30px auto;
      padding: 0 15px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }
    select, input[type=number] {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 15px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #aaa;
    }
    body.dark select, body.dark input[type=number] {
      background-color: #333;
      border: 1px solid #555;
      color: #eee;
    }
    #total-price {
      font-size: 1.2rem;
      margin-bottom: 15px;
    }
    button#save-sale {
      width: 100%;
      padding: 12px;
      background-color: #c62828;
      border: none;
      color: white;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      border-radius: 4px;
    }
    button#save-sale:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    #user-info {
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Store Sales</h1>
    <div style="position: relative;">
      <button id="menu-btn">⋮</button>
      <div id="menu-content">
        <button id="toggle-dark">Toggle Dark Mode</button>
        <button id="go-prices">Edit Prices</button>
        <button id="go-sales">Sales History</button>
        <button id="logout-btn">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <div id="user-info">Loading user...</div>

    <label for="product-select">Select Product</label>
    <select id="product-select"></select>

    <label for="quantity-input">Quantity</label>
    <input type="number" id="quantity-input" min="1" value="1" />

    <div id="total-price">Total Price: 0</div>

    <button id="save-sale" disabled>Save Sale</button>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC-UjeJiOP2-hlD6gAQTKAUL_E_Ns5y0x0",
      authDomain: "store-64757.firebaseapp.com",
      projectId: "store-64757",
      storageBucket: "store-64757.appspot.com",
      messagingSenderpricePerUnit * qty;
      const profit = (pricePerUnit - buyPricePerUnit) * qty;

      try {
        // نخزن المبيعة مع تاريخ اليوم عند المستخدم
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD

        await db.collection('users').doc(user.uid)
          .collection('sales')
          .doc(dateStr)
          .set({
            [product]: firebase.firestore.FieldValue.increment(qty),
            totalPrice: firebase.firestore.FieldValue.increment(totalPrice),
            totalProfit: firebase.firestore.FieldValue.increment(profit),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });

        alert('Sale saved successfully!');
        // نرجع الاختيارات للوضع الافتراضي
        quantityInput.value = 1;
        productSelect.value = '';
        updateTotal();

      } catch (error) {
        alert('Error saving sale: ' + error.message);
      }
    }

    saveSaleBtn.onclick = saveSale;

    // Listen auth state changes
    auth.onAuthStateChanged(async (usr) => {
      if (usr) {
        user = usr;
        userInfo.textContent = `Logged in as: ${user.email}`;
        // جلب أسعار البضائع الخاصة بالمستخدم
        const docRef = db.collection('users').doc(user.uid).collection('settings').doc('prices');
        const doc = await docRef.get();
        if(doc.exists) {
          prices = doc.data();
        } else {
          // لو ما في أسعار مسجلة ننشئ أسعار افتراضية
          prices = {
            "Product A": { price: 15000, buyPrice: 12000 },
            "Product B": { price: 25000, buyPrice: 21000 },
            "Product C": { price: 35000, buyPrice: 30000 }
          };
          await docRef.set(prices);
        }
        populateProducts();
        updateTotal();
      } else {
        // مش مسجل دخول - نفتح نافذة تسجيل دخول جوجل
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(err => {
          userInfo.textContent = 'Login failed: ' + err.message;
        });
      }
    });

    // تحديث السعر عند التغيير
    productSelect.onchange = updateTotal;
    quantityInput.oninput = updateTotal;
  </script>
</body>
</html>
