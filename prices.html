<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sales App - Past Sales</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: white;
    color: black;
  }
  header {
    margin-bottom: 20px;
  }
  a.back {
    text-decoration: none;
    font-size: 18px;
    color: blue;
  }
  select {
    font-size: 18px;
    margin-bottom: 20px;
  }
  table {
    width: 100%;
    max-width: 700px;
    border-collapse: collapse;
  }
  th, td {
    border: 1px solid #999;
    padding: 8px;
    text-align: left;
  }
  button {
    cursor: pointer;
    padding: 5px 10px;
    font-size: 14px;
  }
</style>
</head>
<body>
<header><a class="back" href="index.html">‚Üê Back to Sales</a></header>

<h1>Past Sales</h1>

<label for="dateSelect">Select Date:</label>
<select id="dateSelect"></select>

<table>
  <thead>
    <tr>
      <th>Product</th>
      <th>Quantity</th>
      <th>Price per unit</th>
      <th>Cost per unit</th>
      <th>Total Price</th>
      <th>Profit</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="salesTableBody"></tbody>
</table>

<script>
const dateSelect = document.getElementById('dateSelect');
const salesTableBody = document.getElementById('salesTableBody');

let salesData = JSON.parse(localStorage.getItem('sales')) || {};

function populateDates() {
  dateSelect.innerHTML = '';
  const dates = Object.keys(salesData).sort().reverse();
  if(dates.length === 0){
    dateSelect.innerHTML = '<option>No sales recorded</option>';
    salesTableBody.innerHTML = '';
    return;
  }
  for(const d of dates){
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d;
    dateSelect.appendChild(opt);
  }
  loadSalesForDate(dates[0]);
}

function loadSalesForDate(date){
  salesTableBody.innerHTML = '';
  const sales = salesData[date] || [];
  sales.forEach((sale, idx) => {
    const tr = document.createElement('tr');
    const totalPrice = sale.price * sale.quantity;
    const profit = (sale.price - sale.cost) * sale.quantity;
    tr.innerHTML = `
      <td>${sale.product}</td>
      <td><input type="number" min="1" value="${sale.quantity}" data-index="${idx}" /></td>
      <td>${sale.price.toLocaleString()}</td>
      <td>${sale.cost.toLocaleString()}</td>
      <td>${totalPrice.toLocaleString()}</td>
      <td>${profit.toLocaleString()}</td>
      <td><button data-index="${idx}">Delete</button></td>
    `;
    salesTableBody.appendChild(tr);
  });
  addTableListeners(date);
}

function addTableListeners(date){
  // Handle quantity changes
  salesTableBody.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('change', e => {
      const idx = e.target.getAttribute('data-index');
      let newQty = Number(e.target.value);
      if(newQty < 1 || isNaN(newQty)) {
        alert("Quantity must be at least 1");
        e.target.value = salesData[date][idx].quantity;
        return;
      }
      salesData[date][idx].quantity = newQty;
      localStorage.setItem('sales', JSON.stringify(salesData));
      loadSalesForDate(date);
    });
  });

  // Handle deletes
  salesTableBody.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', e => {
      const idx = e.target.getAttribute('data-index');
      if(confirm("Delete this sale?")){
        salesData[date].splice(idx,1);
        if(salesData[date].length === 0){
          delete salesData[date];
          populateDates();
        } else {
          localStorage.setItem('sales', JSON.stringify(salesData));
          loadSalesForDate(date);
        }
      }
    });
  });
}

dateSelect.addEventListener('change', e => {
  loadSalesForDate(e.target.value);
});

populateDates();
</script>
</body>
</html>
